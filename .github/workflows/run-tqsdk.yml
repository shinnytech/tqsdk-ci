name: CI for tqsdk-python-private
run-name: ${{ github.event.client_payload.title || github.event.head_commit.message || 'Manual CI Trigger' }}

on:
  repository_dispatch:
    types: [ run-tqsdk-ci ]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      tqsdk_ci_ref:
        description: 'tqsdk-ci repository branch/ref to use'
        required: false
        default: 'master'
        type: string
      tqsdk_python_ref:
        description: 'tqsdk-python-private repository branch/ref to test'
        required: false
        default: 'master'
        type: string
      test_type:
        description: 'Test type to run'
        required: false
        default: 'full'
        type: choice
        options:
        - full
        - jupyter-only
        - build-only
        - test-only
      tag_flag:
        description: 'Is this a tag release?'
        required: false
        default: false
        type: boolean
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: false
        type: boolean

jobs:
  setup:
    name: setup and determine parameters
    runs-on: ubuntu-22.04
    outputs:
      target_repository: ${{ steps.set-vars.outputs.target_repository }}
      target_ref: ${{ steps.set-vars.outputs.target_ref }}
      ci_ref: ${{ steps.set-vars.outputs.ci_ref }}
      is_tag_release: ${{ steps.set-vars.outputs.is_tag_release }}
      pr_number: ${{ steps.set-vars.outputs.pr_number }}
      comment_id: ${{ steps.set-vars.outputs.comment_id }}
      test_type: ${{ steps.set-vars.outputs.test_type }}
      debug_mode: ${{ steps.set-vars.outputs.debug_mode }}
      pr_flag: ${{ steps.set-vars.outputs.pr_flag }}
      sha: ${{ steps.set-vars.outputs.sha }}
      tag_name: ${{ steps.set-vars.outputs.tag_name }}
    steps:
      - name: Set variables based on trigger type
        id: set-vars
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "target_repository=shinnytech/tqsdk-python-private" >> $GITHUB_OUTPUT
            echo "target_ref=${{ github.event.client_payload.ref }}" >> $GITHUB_OUTPUT
            echo "ci_ref=${{ github.ref }}" >> $GITHUB_OUTPUT
            echo "is_tag_release=${{ github.event.client_payload.tag_flag }}" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.client_payload.pr_number }}" >> $GITHUB_OUTPUT
            echo "comment_id=${{ github.event.client_payload.comment_id }}" >> $GITHUB_OUTPUT
            echo "test_type=full" >> $GITHUB_OUTPUT
            echo "debug_mode=false" >> $GITHUB_OUTPUT
            echo "pr_flag=${{ github.event.client_payload.pr_flag }}" >> $GITHUB_OUTPUT
            echo "sha=${{ github.event.client_payload.sha }}" >> $GITHUB_OUTPUT
            echo "tag_name=${{ github.event.client_payload.tag_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "target_repository=shinnytech/tqsdk-python-private" >> $GITHUB_OUTPUT
            echo "target_ref=${{ github.event.inputs.tqsdk_python_ref }}" >> $GITHUB_OUTPUT
            echo "ci_ref=${{ github.event.inputs.tqsdk_ci_ref }}" >> $GITHUB_OUTPUT
            echo "is_tag_release=${{ github.event.inputs.tag_flag }}" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "comment_id=" >> $GITHUB_OUTPUT
            echo "test_type=${{ github.event.inputs.test_type }}" >> $GITHUB_OUTPUT
            echo "debug_mode=${{ github.event.inputs.debug_mode }}" >> $GITHUB_OUTPUT
            echo "pr_flag=false" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "tag_name=" >> $GITHUB_OUTPUT
          else
            # For push/pull_request on current repository
            echo "target_repository=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "target_ref=${{ github.ref }}" >> $GITHUB_OUTPUT
            echo "ci_ref=${{ github.ref }}" >> $GITHUB_OUTPUT
            echo "is_tag_release=false" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.number }}" >> $GITHUB_OUTPUT
            echo "comment_id=" >> $GITHUB_OUTPUT
            echo "test_type=full" >> $GITHUB_OUTPUT
            echo "debug_mode=false" >> $GITHUB_OUTPUT
            echo "pr_flag=false" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "tag_name=" >> $GITHUB_OUTPUT
          fi

      - name: Checkout tqsdk-ci repository
        uses: actions/checkout@v4
        with:
          repository: shinnytech/tqsdk-ci
          ref: ${{ steps.set-vars.outputs.ci_ref }}
          token: ${{ secrets.GH_PAT }}
          path: tqsdk-ci

      - name: Dump GitHub context
        if: steps.set-vars.outputs.debug_mode == 'true'
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

      - name: Display selected parameters
        run: |
          echo "Trigger type: ${{ github.event_name }}"
          echo "Target repository: ${{ steps.set-vars.outputs.target_repository }}"
          echo "Target ref: ${{ steps.set-vars.outputs.target_ref }}"
          echo "CI ref: ${{ steps.set-vars.outputs.ci_ref }}"
          echo "Test type: ${{ steps.set-vars.outputs.test_type }}"
          echo "Tag release: ${{ steps.set-vars.outputs.is_tag_release }}"
          echo "Debug mode: ${{ steps.set-vars.outputs.debug_mode }}"

      - name: Add comment show workflow url (external trigger only)
        if: github.event_name == 'repository_dispatch' && steps.set-vars.outputs.pr_number != ''
        uses: peter-evans/create-or-update-comment@v1
        with:
          token: ${{ secrets.GH_PAT }}
          repository: shinnytech/tqsdk-python-private
          issue-number: ${{ steps.set-vars.outputs.pr_number }}
          comment-id: ${{ steps.set-vars.outputs.comment_id }}
          body: |
            - Workflow url: https://github.com/shinnytech/tqsdk-ci/actions/runs/${{ github.run_id }}

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.set-vars.outputs.target_repository }}
          ref: ${{ steps.set-vars.outputs.target_ref }}
          token: ${{ secrets.GH_PAT }}

      - name: Giant Files List
        id: giant-files-list
        run: |
          git ls-files | xargs ls -l | sort -nrk5 | awk '{if($5 > ${{ secrets.FILE_LIMIT_SIZE }}) print $9 }' | xargs ls -lrth
          echo "::set-output name=GIANT-FILES-COUNT::$(git ls-files | xargs ls -l | sort -nrk5 | awk '{if($5 > ${{ secrets.FILE_LIMIT_SIZE }}) print $0}' | wc -l)"

      - name: Giant Files Check
        if: steps.giant-files-list.outputs.GIANT-FILES-COUNT != 0
        run: |
          echo "files size check failed"
          exit 1

  run-jupyter:
    name: test for jupyter
    needs: setup
    if: needs.setup.outputs.test_type == 'full' || needs.setup.outputs.test_type == 'jupyter-only'
    strategy:
      matrix:
        envinfo:
          - { name: 'linux-3.7-x64', os: ubuntu-22.04, python-version: 3.7.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'manylinux1_x86_64' }
          - { name: 'linux-3.8-x64', os: ubuntu-22.04, python-version: 3.8.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'manylinux1_x86_64' }
          - { name: 'linux-3.9-x64', os: ubuntu-22.04, python-version: 3.9.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'manylinux1_x86_64' }
          - { name: 'linux-3.10-x64', os: ubuntu-22.04, python-version: 3.10.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'manylinux1_x86_64' }
          - { name: 'linux-3.11-x64', os: ubuntu-22.04, python-version: 3.11.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'manylinux1_x86_64' }
          - { name: 'linux-3.12-x64', os: ubuntu-22.04, python-version: 3.12.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'manylinux1_x86_64' }
          - { name: 'macos-3.7-x64', os: macos-13, python-version: 3.7.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'any' }
          - { name: 'macos-3.8-x64', os: macos-13, python-version: 3.8.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'any' }
          - { name: 'macos-3.9-x64', os: macos-13, python-version: 3.9.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'any' }
          - { name: 'macos-3.10-x64', os: macos-13, python-version: 3.10.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'any' }
          - { name: 'macos-3.11-x64', os: macos-latest, python-version: 3.11.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'any' }
          - { name: 'macos-3.12-x64', os: macos-latest, python-version: 3.12.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'any' }
          - { name: 'windows-3.7-x64', os: windows-latest, python-version: 3.7.x, python-arch: x64, TZ: 'CST-8', bdist-platform: 'win_amd64' }
          - { name: 'windows-3.8-x64', os: windows-latest, python-version: 3.8.x, python-arch: x64, TZ: 'CST-8', bdist-platform: 'win_amd64' }
          - { name: 'windows-3.9-x64', os: windows-latest, python-version: 3.9.x, python-arch: x64, TZ: 'CST-8', bdist-platform: 'win_amd64' }
          - { name: 'windows-3.10-x64', os: windows-latest, python-version: 3.10.x, python-arch: x64, TZ: 'CST-8', bdist-platform: 'win_amd64' }
          - { name: 'windows-3.11-x64', os: windows-latest, python-version: 3.11.x, python-arch: x64, TZ: 'CST-8', bdist-platform: 'win_amd64' }
          - { name: 'windows-3.12-x64', os: windows-latest, python-version: 3.12.x, python-arch: x64, TZ: 'CST-8', bdist-platform: 'win_amd64' }
    env:
      PYTHONUNBUFFERED: 1
      PYTHONIOENCODING: "utf-8"
      PYTHONHASHSEED: 32
      TZ: ${{ matrix.envinfo.TZ }}
    runs-on: ${{ matrix.envinfo.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.setup.outputs.target_repository }}
          ref: ${{ needs.setup.outputs.target_ref }}
          token: ${{ secrets.GH_PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{matrix.envinfo.python-version}}
          architecture: ${{matrix.envinfo.python-arch}}

      - name: Install dependencies
        run: |
          python -c "import platform;import sys;print(sys.platform, platform.python_version(), platform.system(), platform.machine());"
          python -m pip install setuptools
          # notebook 依赖的 pywinpty 库在 maturin == 1.8.0 版本上编译失败，暂时使用 1.7.8 版本
          python -m pip install maturin==1.7.8
          python -m pip install notebook

      # pandas 在 py>=3.8 时需要安装 pyarrow, 否则报错 DeprecationWarning：Pyarrow will become a required dependency of pandas in the next major release of pandas (pandas 3.0),
      - name: Install dependencies pyarrow
        if: matrix.envinfo.bdist-platform != 'win32' && matrix.envinfo.python-version != '3.7.x'
        run: |
          python -m pip install pyarrow

      - name: Install dependencies on win32
        if: matrix.envinfo.bdist-platform == 'win32' && (matrix.envinfo.python-version == '3.8.x' || matrix.envinfo.python-version == '3.9.x')
        run: |
          python -m pip install scipy==1.8.1
          python -m pip install pandas==1.2.5

      - name: Install dependencies from requirements.txt
        run: |
          python -m pip install -r requirements.txt

      - name: Run Jupyter
        if: matrix.envinfo.bdist-platform != 'win_amd64'
        run: |
          target_dir=$(pwd)
          export PYTHONPATH="$target_dir"
          echo "PYTHONPATH is set to $PYTHONPATH"
          jupyter nbconvert --execute tqsdk/test/notebooks/demo.ipynb --to markdown

      - name: Run Jupyter on Windows
        if: matrix.envinfo.bdist-platform == 'win_amd64'
        run: |
          $env:PYTHONPATH = "D:\a\tqsdk-ci\tqsdk-ci"
          Write-Output "PYTHONPATH is set to $env:PYTHONPATH"
          jupyter nbconvert --execute "tqsdk/test/notebooks/demo.ipynb" --to markdown

  build-web:
    name: build web packages
    runs-on: ubuntu-22.04
    needs: setup
    if: needs.setup.outputs.test_type == 'full' || needs.setup.outputs.test_type == 'build-only'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.setup.outputs.target_repository }}
          ref: ${{ needs.setup.outputs.target_ref }}
          token: ${{ secrets.GH_PAT }}
          submodules: 'recursive'

      - name: Setup Node.js 16.x
        uses: actions/setup-node@v4
        with:
          node-version: 16.x

      - name: Package web
        run: |
          cd ./web/
          yarn config set "strict-ssl" false -g
          yarn install --frozen-lockfile
          yarn run build
        env:
          CI: true

      - name: Upload web package
        uses: actions/upload-artifact@v4
        with:
          name: web-files
          path: tqsdk/web/*

  test-and-build:
    needs: [setup, build-web]
    if: needs.setup.outputs.is_tag_release != 'true' && (needs.setup.outputs.test_type == 'full' || needs.setup.outputs.test_type == 'test-only')
    strategy:
      matrix:
        envinfo:
          - { name: 'linux-3.7-x64', os: ubuntu-22.04, python-version: 3.7.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'manylinux1_x86_64' }
          - { name: 'linux-3.8-x64', os: ubuntu-22.04, python-version: 3.8.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'manylinux1_x86_64' }
          - { name: 'linux-3.9-x64', os: ubuntu-22.04, python-version: 3.9.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'manylinux1_x86_64' }
          - { name: 'linux-3.9-x64', os: ubuntu-22.04, python-version: 3.9.x, python-arch: x64, TZ: '', bdist-platform: 'manylinux1_x86_64' }
          - { name: 'linux-3.10-x64', os: ubuntu-22.04, python-version: 3.10.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'manylinux1_x86_64' }
          #          - { name: 'linux-3.11-x64', os: ubuntu-22.04, python-version: 3.11.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'manylinux1_x86_64'}
          #          - { name: 'linux-3.12-x64', os: ubuntu-22.04, python-version: 3.12.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'manylinux1_x86_64'}
          - { name: 'macos-3.7-x64', os: macos-13, python-version: 3.7.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'any' }
          - { name: 'macos-3.8-x64', os: macos-13, python-version: 3.8.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'any' }
          - { name: 'macos-3.9-x64', os: macos-13, python-version: 3.9.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'any' }
          - { name: 'macos-3.10-x64', os: macos-13, python-version: 3.10.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'any' }
          #          - { name: 'macos-3.11-x64', os: macos-latest, python-version: 3.11.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'any'}
          #          - { name: 'macos-3.12-x64', os: macos-latest, python-version: 3.12.x, python-arch: x64, TZ: 'Asia/Shanghai', bdist-platform: 'any'}
          - { name: 'windows-3.7-x64', os: windows-latest, python-version: 3.7.x, python-arch: x64, TZ: 'CST-8', bdist-platform: 'win_amd64' }
          - { name: 'windows-3.7-x86', os: windows-latest, python-version: 3.7.x, python-arch: x86, TZ: 'CST-8', bdist-platform: 'win32' }
          - { name: 'windows-3.8-x64', os: windows-latest, python-version: 3.8.x, python-arch: x64, TZ: 'CST-8', bdist-platform: 'win_amd64' }
          - { name: 'windows-3.8-x86', os: windows-latest, python-version: 3.8.x, python-arch: x86, TZ: 'CST-8', bdist-platform: 'win32' }
          - { name: 'windows-3.9-x64', os: windows-latest, python-version: 3.9.x, python-arch: x64, TZ: 'CST-8', bdist-platform: 'win_amd64' }
          - { name: 'windows-3.9-x86', os: windows-latest, python-version: 3.9.x, python-arch: x86, TZ: 'CST-8', bdist-platform: 'win32' }
          - { name: 'windows-3.10-x64', os: windows-latest, python-version: 3.10.x, python-arch: x64, TZ: 'CST-8', bdist-platform: 'win_amd64' }
    #          - { name: 'windows-3.10-x86', os: windows-latest, python-version: 3.10.x, python-arch: x86, TZ: 'CST-8', bdist-platform: 'win32'}
    #          - { name: 'windows-3.11-x64', os: windows-latest, python-version: 3.11.x, python-arch: x64, TZ: 'CST-8', bdist-platform: 'win_amd64'}
    #          - { name: 'windows-3.11-x86', os: windows-latest, python-version: 3.11.x, python-arch: x86, TZ: 'CST-8', bdist-platform: 'win32'}
    #          - { name: 'windows-3.12-x64', os: windows-latest, python-version: 3.12.x, python-arch: x64, TZ: 'CST-8', bdist-platform: 'win_amd64'}
    #          - { name: 'windows-3.12-x86', os: windows-latest, python-version: 3.12.x, python-arch: x86, TZ: 'CST-8', bdist-platform: 'win32'}
    # py11 py12 默认的 hash 算法改变，导致测试脚本需要变更，暂时不加在 ci 中，后续计划只在 py11 py12 上运行 ci，需要重新录制脚本


    env:
      PYTHONUNBUFFERED: 1
      PYTHONIOENCODING: "utf-8"
      PYTHONHASHSEED: 32
      TZ: ${{ matrix.envinfo.TZ }}
      TESTLOGPATH: "./log_archive/"
      TESTLOGNAME: ${{ matrix.envinfo.name }}
      TQSDK_RUN_TEST: true

    runs-on: ${{ matrix.envinfo.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.setup.outputs.target_repository }}
          ref: ${{ needs.setup.outputs.target_ref }}
          token: ${{ secrets.GH_PAT }}

      - name: Download web-files
        uses: actions/download-artifact@v4
        with:
          name: web-files
          path: ./tqsdk/web

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{matrix.envinfo.python-version}}
          architecture: ${{matrix.envinfo.python-arch}}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ matrix.envinfo.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ matrix.envinfo.os }}-pip-

      - name: Install dependencies setuptools
        if: matrix.envinfo.python-version == '3.7.x' || matrix.envinfo.python-version == '3.8.x' || matrix.envinfo.python-version == '3.9.x'
        run: |
          python -m pip install setuptools==59.6.0

      - name: Install dependencies
        run: |
          python -c "import platform;import sys;print(sys.platform, platform.python_version(), platform.system(), platform.machine());"
          git lfs install
          git lfs pull
          python -m pip install wheel==0.34.2
          python -m pip install setuptools
          python -m pip install Sphinx==3.3.1

      # pandas 在 py>=3.8 时需要安装 pyarrow, 否则报错 DeprecationWarning：Pyarrow will become a required dependency of pandas in the next major release of pandas (pandas 3.0),
      - name: Install dependencies pyarrow
        if: matrix.envinfo.bdist-platform != 'win32' && matrix.envinfo.python-version != '3.7.x'
        run: |
          python -m pip install pyarrow

      - name: Install dependencies on win32
        if: matrix.envinfo.bdist-platform == 'win32' && (matrix.envinfo.python-version == '3.8.x' || matrix.envinfo.python-version == '3.9.x')
        run: |
          python -m pip install scipy==1.8.1
          python -m pip install pandas==1.2.5

      - name: Install dependencies from requirements.txt
        run: |
          python -m pip install -r requirements.txt

      - name: Run test case parallel
        id: test_case_parallel
        if: needs.setup.outputs.is_tag_release != 'true'
        timeout-minutes: 90
        shell: bash
        env:
          PYTHONWARNINGS: "error,ignore::FutureWarning:tqsdk.api,ignore::DeprecationWarning:tqsdk.channel,ignore::DeprecationWarning:asyncio.queues,ignore::DeprecationWarning:setuptools"
        run: |
          mkdir -p ${{ env.TESTLOGPATH }}
          pytest tqsdk/test --cov=./tqsdk --cov-report xml:coverage1.xml --show-capture=no -n auto -m "not nonparalleltest" --disable-warnings\
            --log-level=ERROR --log-file-format="%(asctime)s - %(levelname)s - %(module)s:%(filename)s:%(lineno)d - %(message)s" --log-file-date-format="%Y-%m-%d %H:%M:%S" \
            --log-file=${{ env.TESTLOGPATH }}${{ env.TESTLOGNAME }}.log

      - name: Run test case
        id: test_case_nonparallel
        if: needs.setup.outputs.is_tag_release != 'true'
        timeout-minutes: 90
        shell: bash
        run: |
          pytest tqsdk/test --cov=./tqsdk --cov-report xml:coverage2.xml -m nonparalleltest --disable-warnings\
            --log-level=ERROR --log-file-format="%(asctime)s - %(levelname)s - %(module)s:%(filename)s:%(lineno)d - %(message)s" --log-file-date-format="%Y-%m-%d %H:%M:%S" \
            --log-file=${{ env.TESTLOGPATH }}${{ env.TESTLOGNAME }}.log

      - name: Upload log to artifact
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TESTLOGNAME }}
          path: ${{ env.TESTLOGPATH }}

  deploy-on-linux:
    if: always() && needs.build-web.result != 'failure' && (needs.setup.outputs.test_type == 'full' || needs.setup.outputs.test_type == 'build-only')
    needs: [setup, build-web, test-and-build]
    strategy:
      matrix:
        envinfo:
          - { name: 'linux-3.9-x64', os: ubuntu-22.04, python-version: 3.9.x, python-arch: x64, bdist-platform: 'linux_x86_64' }

    env:
      PYTHONIOENCODING: "utf-8"

    runs-on: ${{ matrix.envinfo.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.setup.outputs.target_repository }}
          ref: ${{ needs.setup.outputs.target_ref }}
          token: ${{ secrets.GH_PAT }}

      - name: Download web-files
        uses: actions/download-artifact@v4
        with:
          name: web-files
          path: ./tqsdk/web

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{matrix.envinfo.python-version}}
          architecture: ${{matrix.envinfo.python-arch}}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ matrix.envinfo.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ matrix.envinfo.os }}-pip-

      - name: Install dependencies
        run: |
          git lfs install
          git lfs pull
          python -m pip install wheel==0.34.2
          python -m pip install setuptools==59.6.0
          python -m pip install Sphinx==3.3.1
          sudo apt install pandoc
          python -m pip install -r requirements.txt

      - name: edit setup.py to support shinny-pip
        if: needs.setup.outputs.pr_flag == 'true'
        shell: bash
        env:
          PAYLOAD_SHA: ${{ needs.setup.outputs.sha }}
          PAYLOAD_REF: ${{ needs.setup.outputs.target_ref }}
        run: |
          version_pattern="version\s*=\s*['\"].*['\"]"
          short_sha=${PAYLOAD_SHA:0:7}
          ref_name=${PAYLOAD_REF##*/}
          new_version="0.0.0+${ref_name}.$short_sha"
          sed -i "s|$version_pattern|version = \"$new_version\"|" setup.py
          dest_dir=${ref_name}/$short_sha/
          echo "DEST_DIR=$dest_dir" >> $GITHUB_ENV

      - name: Build bdist wheel
        shell: bash
        run: |
          python setup.py sdist
          python setup.py bdist_wheel -p any

      - name: Sphinx build
        shell: bash
        run: |
          rm -rf build
          sphinx-build doc build/doc

      - name: Upload bdist package
        uses: actions/upload-artifact@v4
        with:
          name: bdist-file
          path: dist/*.whl

      - name: Upload sdist package
        uses: actions/upload-artifact@v4
        with:
          name: sdist-file
          path: dist/*.tar.gz

      - name: Upload doc package
        uses: actions/upload-artifact@v4
        with:
          name: doc
          path: build/doc

      - name: Upload doc-files package
        uses: actions/upload-artifact@v4
        with:
          name: doc-files
          path: doc/*

      - name: Publish to pypi
        if: needs.setup.outputs.is_tag_release == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_PASSWORD }}

      - name: Setup ossutil
        if: needs.setup.outputs.is_tag_release == 'true' || needs.setup.outputs.target_ref == 'refs/heads/master' || needs.setup.outputs.pr_flag == 'true'
        uses: yizhoumo/setup-ossutil@v1
        with:
          endpoint: "oss-accelerate.aliyuncs.com"
          access-key-id: ${{ secrets.OSS_ACCESS_KEY }}
          access-key-secret: ${{ secrets.OSS_SECRET_KEY }}

      - name: Upload to Oss - tag
        if: needs.setup.outputs.is_tag_release == 'true'
        shell: bash
        run: |
          ossutil cp -rf build/doc oss://shinnydoc/tqsdk/${{needs.setup.outputs.tag_name}}/

      - name: Upload to Oss - master
        if: needs.setup.outputs.target_ref == 'refs/heads/master'
        shell: bash
        run: |
          ossutil cp -rf build/doc oss://shinnydoc/tqsdk/master/
          ossutil cp -rf build/doc oss://shinnydoc/tqsdk/latest/

      - name: Upload to Oss - pr 
        if: needs.setup.outputs.pr_flag == 'true'
        shell: bash
        run: |
          ossutil cp -f dist/*.whl oss://shinny-cd/tqsdk/"$DEST_DIR"dist/

  tqsdk-python:
    name: tqsdk-python commit and pr
    runs-on: ubuntu-22.04
    if: always() && needs.setup.outputs.is_tag_release == 'true'
    needs: [setup, deploy-on-linux]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: shinnytech/tqsdk-python
          ref: master
          token: ${{ secrets.GH_PAT }}

      - name: Download doc
        uses: actions/download-artifact@v4
        with:
          name: doc-files
          path: ./doc

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist-file
          path: ../

      - name: unzip
        shell: bash
        run: |
          cd ..
          tar -x -f *.tar.gz
          cp -R tqsdk-${{needs.setup.outputs.tag_name}}/* tqsdk-ci
          cd tqsdk-ci
          git status

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GH_PAT }}
          commit-message: "Update Version ${{ needs.setup.outputs.tag_name }}"
          branch-suffix: short-commit-hash
          title: '[Tqsdk-Ci] Update Version ${{ needs.setup.outputs.tag_name }}'

  summary:
    name: summary CI result
    needs: [ setup, run-jupyter, build-web, test-and-build, deploy-on-linux ]
    runs-on: ubuntu-22.04
    if: always() && needs.setup.outputs.pr_number != ''
    steps:
      - name: Find Comment
        uses: peter-evans/find-comment@v1
        id: fc
        with:
          repository: shinnytech/tqsdk-python-private
          token: ${{ secrets.GH_PAT }}
          issue-number: ${{ needs.setup.outputs.pr_number }}
          body-includes: https://github.com/shinnytech/tqsdk-ci/actions/runs/${{ github.run_id }}

      - name: Add comment show success
        uses: peter-evans/create-or-update-comment@v1
        with:
          token: ${{ secrets.GH_PAT }}
          repository: shinnytech/tqsdk-python-private
          issue-number: ${{ needs.setup.outputs.pr_number }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          body: |
            workflow ${{ github.run_id }} run success!
          reactions: '+1'
